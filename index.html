<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>ローマ字タイピング練習</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" integrity="sha512-9usAa10IRO0HhonpyAIVpjrylPvoDwiPUiKdWk5t3PyolY1cOd4DSE0Ga+ri4AuTroPR5aQvXU9xC6qOPnzFeg==" crossorigin="anonymous" referrerpolicy="no-referrer" />
  <style>
    * { box-sizing: border-box; }

    body {
      margin: 0;
      padding: 0;
      font-family: 'Segoe UI', sans-serif;
      background: linear-gradient(to bottom right, #2c3e50, #3498db);
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      height: 100vh;
      color: #fff;
    }

    .card {
      background: rgba(255, 255, 255, 0.1);
      padding: 30px 25px;
      border-radius: 20px;
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
      width: 90%;
      max-width: 500px;
      text-align: center;
      backdrop-filter: blur(10px);
      margin-bottom: 20px;
    }

    .kanji { font-size: 56px; font-weight: bold; margin-bottom: 10px; }
    .kana { font-size: 24px; color: #dcdcdc; margin-bottom: 30px; }

    input[type="text"] {
      font-size: 24px;
      padding: 12px 20px;
      width: 100%;
      border: none;
      border-radius: 10px;
      outline: none;
      box-shadow: 0 4px 10px rgba(0,0,0,0.2);
    }

    input[type="text"]:focus {
      box-shadow: 0 0 10px 2px #74b9ff;
    }

    .settings {
      display: none; /* 初期状態で非表示 */
      flex-direction: column;
      gap: 10px;
      align-items: center;
      background: rgba(0, 0, 0, 0.2);
      padding: 20px;
      border-radius: 15px;
      position: absolute; /* 歯車アイコンで開くため */
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      z-index: 100; /* 最前面に表示 */
    }

    select, input[type="number"] {
      font-size: 16px;
      padding: 8px 12px;
      border-radius: 8px;
      border: none;
      width: 200px;
    }

    .timer {
      margin-top: 10px;
      font-size: 20px;
      color: #ffecb3;
    }

    .settings-icon {
      position: absolute;
      top: 20px;
      right: 20px;
      font-size: 28px;
      color: #fff;
      cursor: pointer;
      z-index: 101; /* 常に最前面に表示 */
    }

    .button-container {
      display: flex;
      gap: 10px;
      margin-top: 20px;
    }

    .button-container button {
      padding: 10px 20px;
      font-size: 16px;
      border-radius: 8px;
      border: none;
      background-color: #007bff;
      color: #fff;
      cursor: pointer;
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
      transition: background-color 0.3s ease;
    }

    .button-container button:hover {
      background-color: #0056b3;
    }

    /* 終了ボタンのスタイル */
    .button-container button.stop-button {
      background-color: #dc3545;
    }

    .button-container button.stop-button:hover {
      background-color: #c82333;
    }

    /* タイピング画面が非表示のときに背景を暗くするオーバーレイ */
    .overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      backdrop-filter: blur(5px);
      z-index: 99;
      display: none; /* 初期状態で非表示 */
    }
  </style>
</head>
<body>

  <i class="fas fa-cog settings-icon" onclick="toggleSettings()"></i>

  <div class="settings" id="settingsPanel">
    <h3>設定</h3>
    <label>制限時間:
      <select id="timeMode">
        <option value="none">なし</option>
        <option value="custom">カスタム</option>
      </select>
    </label>
    <input type="number" id="customSeconds" placeholder="秒数" min="1" max="300" style="display:none;">
    <button onclick="toggleSettings()">閉じる</button>
  </div>

  <div class="overlay" id="overlay"></div>

  <div class="card" id="gameCard">
    <div class="kanji" id="kanji">スタートボタンを押して開始！</div>
    <div class="kana" id="kana"></div>
    <input type="text" id="romajiInput" placeholder="ローマ字で入力" disabled>
  </div>

  <div class="button-container">
    <button onclick="startGame()">スタート</button>
    <button class="stop-button" onclick="stopGame()">終了</button>
  </div>

  <div class="timer" id="timerDisplay"></div>

  <script>
    const kanjiEl = document.getElementById("kanji");
    const kanaEl = document.getElementById("kana");
    const inputEl = document.getElementById("romajiInput");
    const timeModeEl = document.getElementById("timeMode");
    const customSecondsEl = document.getElementById("customSeconds");
    const timerDisplay = document.getElementById("timerDisplay");
    const settingsPanel = document.getElementById("settingsPanel");
    const gameCard = document.getElementById("gameCard");
    const overlay = document.getElementById("overlay");

    let words = []; // words.json から読み込むため空で初期化

    let currentWord = null;
    let timeLimit = null;
    let timer = null;

    // UI切り替え: 制限時間モード
    timeModeEl.addEventListener("change", () => {
      customSecondsEl.style.display = timeModeEl.value === "custom" ? "block" : "none";
    });

    // データ読み込み
    fetch("words.json")
      .then(res => res.json())
      .then(data => { words = data; })
      .catch(err => {
        kanjiEl.textContent = "データ読み込み失敗";
        kanaEl.textContent = "words.json が見つからないか、形式が正しくありません。";
        console.error(err);
      });

    // 設定パネルの表示/非表示を切り替える関数
    function toggleSettings() {
      if (settingsPanel.style.display === "none" || settingsPanel.style.display === "") {
        settingsPanel.style.display = "flex";
        gameCard.style.display = "none"; // ゲーム画面を非表示
        overlay.style.display = "block"; // オーバーレイを表示
        clearInterval(timer); // ゲーム中に設定を開いたらタイマーを停止
      } else {
        settingsPanel.style.display = "none";
        gameCard.style.display = "block"; // ゲーム画面を再表示
        overlay.style.display = "none"; // オーバーレイを非表示
        // 設定を閉じた際に、単語データがまだ読み込まれていなければエラー表示
        if (words.length === 0 && kanjiEl.textContent === "データ読み込み失敗") {
            // 何もしない。既にエラーメッセージが表示されているため
        } else if (words.length === 0) {
            // まだ読み込み中で表示が初期状態の場合
            kanjiEl.textContent = "データ読み込み中...";
            kanaEl.textContent = "";
        } else {
            // 正常に読み込まれている場合
            kanjiEl.textContent = "スタートボタンを押して開始！";
            kanaEl.textContent = "";
        }
      }
    }

    function startGame() {
      // 単語リストが空の場合は開始しない
      if (words.length === 0) {
        kanjiEl.textContent = "単語データが読み込まれていません。";
        kanaEl.textContent = "words.json が正しく設置されているか確認してください。";
        return;
      }

      // ゲームが既に終了状態ならリセット
      if (inputEl.disabled) {
        kanjiEl.textContent = "スタートボタンを押して開始！";
        kanaEl.textContent = "";
        timerDisplay.textContent = "";
      }

      // 設定パネルが開いている場合は閉じる
      if (settingsPanel.style.display === "flex") {
        toggleSettings();
      }

      // タイマー設定
      const mode = timeModeEl.value;
      if (mode === "custom") {
        timeLimit = parseInt(customSecondsEl.value) || 30; // デフォルトは30秒
      } else {
        timeLimit = null; // 制限時間なし
        timerDisplay.textContent = "";
      }

      setNewWord();
      inputEl.disabled = false;
      inputEl.value = "";
      inputEl.focus();

      // タイマー起動
      if (timeLimit !== null) { // nullチェックで制限時間なしの場合を考慮
        clearInterval(timer); // 既存のタイマーをクリア
        let secondsLeft = timeLimit;
        timerDisplay.textContent = `残り: ${secondsLeft} 秒`;

        timer = setInterval(() => {
          secondsLeft--;
          timerDisplay.textContent = `残り: ${secondsLeft} 秒`;
          if (secondsLeft <= 0) {
            stopGame(); // 時間が来たらゲーム終了
          }
        }, 1000);
      } else {
        clearInterval(timer); // 制限時間なしの場合はタイマーを停止
        timerDisplay.textContent = "";
      }
    }

    function setNewWord() {
      currentWord = words[Math.floor(Math.random() * words.length)];
      kanjiEl.textContent = currentWord.kanji;
      kanaEl.textContent = currentWord.kana;
      inputEl.value = "";
    }

    function stopGame() {
      clearInterval(timer); // タイマーを停止
      kanjiEl.textContent = "終了！";
      kanaEl.textContent = "";
      inputEl.disabled = true; // 入力フィールドを無効化
      inputEl.value = ""; // 入力フィールドをクリア
      timerDisplay.textContent = ""; // タイマー表示をクリア
    }

    // Enterキーでチェック
    inputEl.addEventListener("keydown", (e) => {
      // inputEl.disabledがtrueの場合は何もしない (ゲーム停止中)
      if (inputEl.disabled) return;

      if (e.key === "Enter") {
        const typedRomaji = inputEl.value.toLowerCase();
        // 正しいローマ字、または代替ローマ字のいずれかに一致するかをチェック
        // currentWord.altRomaji が存在し、かつ配列であるかを確認
        const isAltRomajiMatch = currentWord.altRomaji && Array.isArray(currentWord.altRomaji) && currentWord.altRomaji.includes(typedRomaji);

        if (typedRomaji === currentWord.romaji || isAltRomajiMatch) {
          setNewWord();
        }
      }
    });

    // 初期表示設定
    stopGame(); // 初期状態でゲームを停止状態にする
    kanjiEl.textContent = "データ読み込み中..."; // 初期メッセージ
  </script>
</body>
</html>
